---
name: adr-writer
description: アーキテクチャ決定記録(ADR)の作成。音声販売AI(VLF)の設計判断を記録し、docs/ADR/に保存する。
---

# ADR Writer Skill (requirements_VLF)

このスキルは、音声販売AI（VLF）プロジェクトにおけるアーキテクチャ決定記録（ADR: Architecture Decision Record）を作成・管理するための標準手順を定義します。

## 適用タイミング

以下のリクエストに自動適用されます：
- ADRの作成依頼
- 設計判断の記録が必要な仕様変更
- アーキテクチャに影響する意思決定
- OpenQuestionsから決定事項への移行

## ADR作成基準

以下のいずれかに該当する場合、ADRを作成します：

### 必須（Must）
- 状態遷移図（Mermaid）への状態追加・削除
- ツール契約（getStock, getPrice, getDeliveryDate, saveOrder）の変更
- エラーハンドリング戦略の変更（リトライ回数、タイムアウト等）
- DB保存タイミングの変更

### 推奨（Should）
- 数値パラメータ（閾値、タイムアウト）の設計根拠
- セキュリティに関わる判断
- パフォーマンスに影響する設計選択
- 外部依存（API、ツール）の選定理由

### 任意（May）
- 命名規則の変更
- ドキュメント構造の変更

## ADRファイル命名規則

```
docs/ADR/YYYY-MM-DD-<decision-title>.md
```

**例**:
- `2025-01-07-add-retry-logic-to-saveOrder.md`
- `2025-01-10-change-silence-threshold-from-5s-to-3s.md`

## ADRテンプレート

```markdown
# ADR-XXX: <タイトル>

**日付**: YYYY-MM-DD
**状態**: Proposed / Accepted / Deprecated / Superseded
**決定者**: <担当者名 or チーム名>

## 文脈（Context）

なぜこの決定が必要になったのか、背景を記載。

- 解決すべき課題
- 現状の問題点
- ビジネス要件

## 検討した選択肢（Options Considered）

最低2つ以上の選択肢を比較。

### Option 1: <選択肢1の名前>
- **概要**:
- **メリット**:
- **デメリット**:
- **コスト/リスク**:

### Option 2: <選択肢2の名前>
- **概要**:
- **メリット**:
- **デメリット**:
- **コスト/リスク**:

## 決定（Decision）

**選択した選択肢**: Option X

**理由**:
- なぜこの選択肢を選んだのか
- トレードオフの判断基準

## 結果（Consequences）

### ポジティブ
- 期待される改善点
- 得られる利点

### ネガティブ
- 発生しうる問題
- 今後のメンテナンスコスト

### ニュートラル
- 変更が必要なファイル
- 影響範囲

## 関連リンク

- **仕様**: ConversationSpec.md §X
- **OpenQuestions**: OQ-XXX（該当する場合）
- **関連ADR**: ADR-YYY（該当する場合）
- **外部参考**: <URL>（該当する場合）

## 検証方法

- [ ] どのようにこの決定が正しいか検証するか
- [ ] 失敗の兆候（何が起きたら見直すか）
```

## 作成手順

### 1. ADR番号の採番

```bash
# docs/ADR/ ディレクトリ内の既存ADRを確認
ls docs/ADR/ | grep "^ADR-" | sort -V | tail -1
```

次の連番を採用（例: 既存が ADR-003 なら ADR-004）

### 2. 文脈の明確化

以下を確認して記載：
- 関連する仕様ファイル（ConversationSpec.md、PRD.md等）
- OpenQuestions の該当項目（OQ-XXX）
- 変更の背景（なぜ今この決定が必要か）

### 3. 選択肢の列挙

**最低2つ以上**の選択肢を比較検討：
- 現状維持（何もしない）も選択肢の1つ
- メリット・デメリットを客観的に記載
- コスト（実装時間、保守性）とリスク（失敗時の影響）を明記

### 4. 決定の記録

- どの選択肢を選んだのか
- なぜその選択肢が最適か（判断基準を明記）
- トレードオフの内容

### 5. 影響範囲の特定

- どのファイルが変更されるか（例: ConversationSpec.md §3.2）
- 他のADRとの関係（依存、矛盾、上書き）
- OpenQuestionsとの関係（決定により解決するOQ-XXXをクローズ）

## OpenQuestionsとの連携

### OpenQuestionが解決した場合

1. ADRを作成
2. OpenQuestions.md の該当行を更新：
   - 状態を `Open` → `Resolved`
   - 解決理由欄に `ADR-XXX参照` を記載

**例**:
```markdown
| OQ-001 | EX_Silenceの無音閾値は5秒で適切か？ | ConversationSpec §3 | 要確認 | MVP前 | Resolved (ADR-004参照) |
```

### OpenQuestionが新たに発生した場合

1. ADRの「結果 > ニュートラル」に記載
2. OpenQuestions.md に新規エントリを追加

## 状態管理

ADRの状態は以下のいずれか：

- **Proposed**: 提案中（レビュー待ち）
- **Accepted**: 承認済み（実装可能）
- **Deprecated**: 非推奨（新しいADRで置き換え推奨）
- **Superseded**: 上書き済み（ADR-YYYで置き換え）

## 禁止事項

- **実装コードの記載禁止**: ADRは設計判断の記録であり、コードは含めない
- **曖昧な表現の禁止**: 「おそらく」「たぶん」等の推測表現は使わない
- **選択肢1つのみの記載禁止**: 必ず複数の選択肢を比較する

## エラーハンドリング

### ADR番号の重複
- 既存ADRの番号を確認し、必ず連番を使用
- ファイル名の日付とADR番号は独立（日付は作成日、番号は連番）

### 関連仕様ファイルが存在しない
- 該当する仕様ファイルを先に作成・更新
- ADRは仕様変更の**記録**であり、仕様そのものではない

## 出力フォーマット

### 完了メッセージ

```markdown
## ADR作成完了

- **ファイル**: docs/ADR/2025-01-07-<decision-title>.md
- **ADR番号**: ADR-004
- **状態**: Proposed

## 次のアクション
- [ ] レビュー依頼（PR作成）
- [ ] 関連する仕様ファイルの更新（該当する場合）
- [ ] OpenQuestions.md の該当項目をクローズ（該当する場合）
```

## スキル実行例

**ユーザー**: 「saveOrderのリトライロジックを追加する判断をADRに記録して」

**実行内容**:
1. docs/ADR/ の既存ADRを確認し、次の番号を採番（例: ADR-005）
2. テンプレートに基づきADRを作成
   - 文脈: saveOrder失敗時の対応が未定義（OQ-006参照）
   - 選択肢1: リトライなし（即座にエラー終了）
   - 選択肢2: リトライ1回（現状の仕様）
   - 選択肢3: リトライ3回（高可用性重視）
3. 決定: 選択肢2を採用（MVP範囲ではシンプルさ優先）
4. 影響範囲: ConversationSpec.md §4 saveOrder
5. OpenQuestions.md の OQ-006 をクローズ
6. 差分要約を出力
