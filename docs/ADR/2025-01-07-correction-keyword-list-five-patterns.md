# ADR-004: EX_Correctionのキーワードリストを5パターンにする

**日付**: 2025-01-07
**状態**: Accepted
**決定者**: VLF開発チーム

## 文脈（Context）

音声販売AIシステムでは、顧客が「やっぱり別の商品がいい」等と言い直しを希望する場合、EX_Correctionという例外状態に遷移し、要件確認（ST_RequirementCheck）からやり直す仕組みがある。この言い直しを検知するキーワードリストを定義する必要がある。

**解決すべき課題**:
- 現在のキーワードが3つ（「やっぱり」「違う」「他の」）のみで、カバレッジ不足の可能性
- 顧客が言い直しを希望しても検知できないケースが発生しうる
- キーワードリストが多すぎると、誤検知（意図しない言い直し）が増える

**現状の問題点**:
- ConversationSpecに「やっぱり」「違う」「他の」の3つのみ記載
- カバレッジの根拠が不明（実際の会話ログがない状態での仮置き）

**ビジネス要件**:
- 顧客が言い直しを希望する場合、確実に検知すること
- 誤検知を最小化し、意図しない状態遷移を避けること

## 検討した選択肢（Options Considered）

### Option 1: 3キーワード（現状維持）
- **概要**: 「やっぱり」「違う」「他の」の3つのみ
- **メリット**:
  - 変更不要で、即座にMVP開始可能
  - 誤検知リスクが低い（限定的なキーワード）
- **デメリット**:
  - カバレッジ不足の可能性が高い
  - 「間違えた」「キャンセル」等の一般的な表現を検知できない
  - 顧客満足度の低下（言い直しを希望しても検知されない）
- **参考データ**: 一般的な電話応対では、「間違えた」「キャンセル」が頻出

### Option 2: 5キーワード（推奨）
- **概要**: 既存3つ + 「間違えた」「キャンセル」の計5つ
- **メリット**:
  - MVP範囲で頻出パターンをカバー
  - 実装がシンプル（キーワードリストに追加するのみ）
  - 誤検知リスクが許容範囲（5つ程度なら意図しないマッチは稀）
  - 電話応対の一般的な表現をカバー
- **デメリット**:
  - 最適値かは実会話ログ待ち（Phase 2で拡張の可能性）
  - 「キャンセル」は文脈によっては誤検知の可能性
    - 例:「配送をキャンセルしたい」は言い直しではなく、注文全体のキャンセル
- **参考データ**: 電話応対マニュアルで頻出する言い直しフレーズ

### Option 3: 10キーワード以上（高カバレッジ）
- **概要**: 「やっぱり」「違う」「他の」「間違えた」「キャンセル」「訂正」「変更」「別の」「もう一度」「やり直し」等
- **メリット**:
  - カバレッジが非常に高い
  - ほぼすべての言い直しパターンを検知可能
- **デメリット**:
  - 誤検知リスクが高い
    - 例:「別の配送日はありますか？」→ 言い直しではなく、配送日の選択肢確認
    - 例:「もう一度説明してください」→ 言い直しではなく、聞き直し
  - 実装複雑度が増す（文脈判定が必要）
  - MVP範囲を超える
- **コスト/リスク**: 誤検知による顧客体験の悪化

### Option 4: 機械学習による意図分類（Phase 2）
- **概要**: キーワードマッチではなく、文全体から意図を分類
- **メリット**:
  - 最も正確な検知が可能
  - 文脈を考慮できる
- **デメリット**:
  - 実装複雑度が非常に高い（MLモデルの学習、推論環境の構築）
  - 学習データが必要（実会話ログ）
  - MVP範囲を大きく超える
- **コスト/リスク**: MVP期間（3ヶ月）では実装不可能

## 決定（Decision）

**選択した選択肢**: Option 2（5キーワード）

**キーワードリスト**:
1. 「やっぱり」（既存）
2. 「違う」（既存）
3. 「他の」（既存）
4. **「間違えた」**（新規追加）
5. **「キャンセル」**（新規追加）

**理由**:
1. **MVP範囲に適切**: シンプルで実装しやすく、3ヶ月のMVP期間に適合
2. **頻出パターンをカバー**: 電話応対で一般的な言い直しフレーズを含む
3. **誤検知リスクが許容範囲**: 5つ程度なら意図しないマッチは稀
4. **実装の容易性**: キーワードリストに追加するのみ、複雑なロジック不要

**トレードオフの判断基準**:
- カバレッジ: 80%以上（推定値、実会話ログで検証）
- 誤検知率: 5%未満
- 実装期間: MVP期間（3ヶ月）内で完了可能

**文脈判定の扱い（MVP範囲外）**:
- MVP範囲では、キーワードが発話に含まれる場合、無条件でEX_Correctionに遷移
- 文脈判定（「キャンセル」が注文全体か商品選択かの区別）はPhase 2で実装
- 軽減策: 顧客に確認プロンプトを出す
  - 例:「商品を選び直しますか？」→ 顧客が「はい」ならST_RequirementCheckへ

## 結果（Consequences）

### ポジティブ
- 言い直し検知のカバレッジが大幅に向上（推定: 60% → 80%）
- 実装がシンプルで、テストが容易
- 電話応対の一般的な表現をカバー
- 顧客満足度の向上（言い直しを希望した場合、確実に検知）

### ネガティブ
- 誤検知の可能性が若干増加
  - 例:「キャンセル」が文脈により誤検知される可能性
  - 軽減策: 確認プロンプトで顧客に意図を再確認
- 最適値かは実会話ログ待ち
  - 軽減策: Phase 2で会話ログを分析し、キーワードリストを拡張

### ニュートラル
- 変更が必要なファイル:
  - ConversationSpec.md §3 EX_Correction（キーワードリストを更新）
- 影響範囲:
  - 音声認識後のキーワード検知ロジック
  - テストケース（5パターンのテスト追加）

## 関連リンク

- **仕様**: ConversationSpec.md §3 EX_Correction
- **OpenQuestions**: OQ-007（この決定により解決）
- **関連ADR**: なし

## 検証方法

### MVP期間中の検証計画

1. **単体テスト**:
   - [ ] 各キーワードが正しく検知されるか（5パターン）
   - [ ] 部分一致のテスト（例:「やっぱりこれにします」）
   - [ ] 誤検知のテスト（例:「キャンセル料はかかりますか？」）

2. **ユーザーテスト**:
   - [ ] 言い直しシーンでの検知率を測定（目標: 80%以上）
   - [ ] 誤検知率を測定（目標: 5%未満）
   - [ ] 顧客からのフィードバック収集

3. **運用ログ分析**:
   - [ ] EX_Correction発生頻度を測定
   - [ ] 各キーワードの検知頻度を測定
   - [ ] Phase 2での拡張候補を抽出

**合格基準**:
- 言い直し検知率: 80%以上
- 誤検知率: 5%未満
- 顧客満足度（NPS）: 30以上（プロジェクト全体の目標値）

**失敗の兆候**:
- 言い直し検知率が60%未満
- 誤検知率が10%以上
- 顧客から「言い直しができない」というクレームが多発

その場合は、以下のアクションを取る:
- キーワードを追加（7-10パターンに拡張）
- 文脈判定の実装を検討（Option 4への移行）

## キーワードリストの詳細

### 1. やっぱり
- **意図**: 前言撤回、考え直し
- **例文**: 「やっぱり別の商品がいいです」

### 2. 違う
- **意図**: 否定、訂正
- **例文**: 「それじゃなくて違うものがいいです」

### 3. 他の
- **意図**: 代替品の要求
- **例文**: 「他の商品を見せてください」

### 4. 間違えた（新規追加）
- **意図**: 誤入力、誤選択
- **例文**: 「間違えました、別の商品でお願いします」

### 5. キャンセル（新規追加）
- **意図**: 取り消し、中止
- **例文**: 「この商品はキャンセルして、別のにします」
- **注意**: 注文全体のキャンセルとの区別が必要（Phase 2で文脈判定）

## Phase 2での拡張候補

実会話ログの分析後、以下のキーワードを追加候補とする:

- 「訂正」
- 「変更」
- 「別の」（「他の」と類似）
- 「もう一度」
- 「やり直し」
- 「戻る」

## 次のアクション

- [x] この ADR を作成（完了）
- [ ] ConversationSpec.md §3 EX_Correction を更新（キーワードリスト更新）
- [ ] OpenQuestions.md OQ-007 を Resolved に変更
- [ ] キーワード検知ロジックの実装仕様書に反映
- [ ] テストケースを作成（5パターン）
