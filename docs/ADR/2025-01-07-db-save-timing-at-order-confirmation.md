# ADR-001: DB保存タイミングをST_OrderConfirmationの「はい」受信時のみにする

**日付**: 2025-01-07
**状態**: Accepted
**決定者**: VLF開発チーム

## 文脈（Context）

音声販売AIシステムでは、顧客が商品を選択し、価格・配送日を確認した後、最終的な注文確定を行う。この注文データをDBに保存するタイミングをいつにするかが重要な設計判断となる。

**解決すべき課題**:
- 注文データの永続化タイミングが不明確だと、システム障害時に注文が失われる
- 早すぎるタイミングで保存すると、キャンセル処理が複雑化する
- 遅すぎるタイミングだと、顧客が「はい」と答えた後にシステム障害が起きた場合、注文が失われる

**現状の問題点**:
- ConversationSpecには「いつDBに保存するか」の明確な記述が必要
- トランザクション境界が不明確

**ビジネス要件**:
- 顧客が明確に「はい」と答えた時点で注文が確定する
- 注文確定前のキャンセルはペナルティなし
- 注文確定後のキャンセルは別フロー（Phase 2）

## 検討した選択肢（Options Considered）

### Option 1: ST_ProductSuggestion時点で保存（早期保存）
- **概要**: 商品選択が確定した時点でDB保存
- **メリット**:
  - データロストのリスクが低い
  - 顧客行動の分析データが豊富
- **デメリット**:
  - キャンセル処理が複雑（価格確認後、配送日確認後にキャンセルの場合）
  - 未確定の注文データがDBに大量に蓄積
  - トランザクション管理が複雑
- **コスト/リスク**: DB容量増加、実装複雑度が高い

### Option 2: ST_OrderConfirmation時点で保存（最終確認後）
- **概要**: 顧客が「はい」と答えた時点でDB保存
- **メリット**:
  - トランザクション境界が明確
  - キャンセル処理が不要（保存前はメモリ上のみ）
  - DBに保存されるのは確定注文のみ
  - ビジネス要件と一致（「はい」で確定）
- **デメリット**:
  - 「はい」受信後、DB保存前に障害が起きると注文ロスト
  - 顧客の検討履歴データが取れない（Phase 2で検討）
- **コスト/リスク**: DB保存失敗時のリトライロジックが必要

### Option 3: 各ステップで逐次保存（段階的保存）
- **概要**: ST_ProductSuggestion、ST_PriceQuote、ST_DeliveryCheck、ST_OrderConfirmationの各段階で保存
- **メリット**:
  - データロストのリスクが最小
  - 顧客の検討プロセスが完全に記録される
- **デメリット**:
  - 実装複雑度が非常に高い
  - 各ステップでDB I/Oが発生し、レイテンシが増加
  - トランザクション管理が極めて複雑
  - MVP範囲を超える
- **コスト/リスク**: 開発期間の大幅延長、パフォーマンス低下

## 決定（Decision）

**選択した選択肢**: Option 2（ST_OrderConfirmation時点で保存）

**理由**:
1. **ビジネス要件との一致**: 顧客が「はい」と答えた時点が注文確定のタイミングとして自然
2. **MVP範囲に適切**: シンプルで実装しやすい
3. **トランザクション境界の明確性**: 保存タイミングが1箇所のみで、エラーハンドリングが容易
4. **キャンセル処理が不要**: 保存前はメモリ上のみなので、キャンセル＝データ破棄で済む

**トレードオフの判断基準**:
- MVP期間（3ヶ月）での実装可能性を最優先
- データロストリスクはリトライロジック（OQ-006参照）で軽減
- 顧客の検討履歴はPhase 2で別途実装（ログベースの分析）

## 結果（Consequences）

### ポジティブ
- トランザクション境界が明確になり、実装が容易
- DBに蓄積されるのは確定注文のみで、データの品質が高い
- キャンセル処理が不要（保存前はメモリ上のみ）
- テストが容易（保存タイミングが1箇所のみ）

### ネガティブ
- 「はい」受信後、DB保存前の障害で注文ロストの可能性
  - 軽減策: saveOrderのリトライロジック（1回、OQ-006で検討中）
- 顧客の検討履歴データが取れない
  - 軽減策: Phase 2で会話ログベースの分析を実装

### ニュートラル
- 変更が必要なファイル:
  - ConversationSpec.md §1 ST_OrderConfirmation（DB保存タイミングを明記）
  - ConversationSpec.md §4 saveOrder（トランザクション保証を明記）
- 影響範囲:
  - saveOrderツールの実装仕様
  - エラーハンドリング（DB保存失敗時のリトライ）

## 関連リンク

- **仕様**: ConversationSpec.md §1 ST_OrderConfirmation、§4 saveOrder
- **OpenQuestions**: OQ-006（saveOrderのリトライ回数）
- **関連ADR**: なし（初回ADR）

## 検証方法

- [x] ConversationSpec.mdに「DB保存タイミング」が明記されているか
- [x] saveOrderツールのInput/Output仕様が明確か
- [ ] saveOrder失敗時のリトライロジックが実装されているか（実装フェーズで確認）
- [ ] 障害テスト（DB接続断）で注文ロストが発生しないか（テストフェーズで確認）

**失敗の兆候**:
- 注文ロスト率が1%を超える
- DB保存失敗率が5%を超える
- 顧客から「注文したのに記録されていない」というクレームが多発

その場合は、saveOrderのリトライ回数増加、またはOption 3への移行を検討する。
