# ADR-003: saveOrderのリトライ回数を1回にする

**日付**: 2025-01-07
**状態**: Accepted
**決定者**: VLF開発チーム

## 文脈（Context）

音声販売AIシステムでは、顧客が「はい」と答えた時点で注文データをDBに保存する（ADR-001参照）。このDB保存処理（saveOrder）が失敗した場合、リトライを何回実施するかを決定する必要がある。

**解決すべき課題**:
- DB保存失敗時の対応が不明確
- リトライ回数が多すぎると、顧客を長時間待たせる
- リトライ回数が少なすぎると、一時的な障害で注文が失われる

**現状の問題点**:
- ConversationSpecに「リトライ1回」とだけ記載されており、根拠が不明
- トランザクション特性（リトライ可能な失敗 vs 不可能な失敗）の考慮が不足

**ビジネス要件**:
- 注文ロスト率を最小化すること
- 顧客の待ち時間を最小化すること（通話時間＝コスト）

## 検討した選択肢（Options Considered）

### Option 1: リトライなし（0回）
- **概要**: DB保存失敗時、即座にエラー終了
- **メリット**:
  - 実装が最もシンプル
  - 顧客の待ち時間が最短
  - 失敗原因が明確（一時的障害かどうかの判断不要）
- **デメリット**:
  - 一時的なDB接続断で注文ロストの可能性が高い
  - ネットワーク瞬断等で不必要に失敗する
  - ビジネス要件（注文ロスト最小化）と矛盾
- **コスト/リスク**: 注文ロスト率が高く、顧客満足度が低下

### Option 2: リトライ1回（推奨）
- **概要**: DB保存失敗時、1回だけリトライ
- **メリット**:
  - 一時的な障害（ネットワーク瞬断、DB高負荷）に対応可能
  - 顧客の待ち時間が許容範囲（2-3秒程度）
  - 実装がシンプル（リトライロジックは単純）
  - MVP範囲として適切な複雑度
- **デメリット**:
  - 永続的な障害（DB停止、トランザクションデッドロック）には効果がない
  - 2回連続で失敗する場合もある
- **コスト/リスク**: バランスが良い、MVP範囲として妥当

### Option 3: リトライ3回（高可用性重視）
- **概要**: DB保存失敗時、最大3回リトライ
- **メリット**:
  - 一時的な障害への対応が最も強固
  - 注文ロスト率が最小
- **デメリット**:
  - 顧客の待ち時間が長い（最大6-9秒）
  - 永続的な障害の場合、無駄な待ち時間
  - 実装複雑度が増す（指数バックオフ等を考慮すべき）
  - MVP範囲を超える
- **コスト/リスク**: 実装コストが高い、Phase 2で検討すべき

### Option 4: リトライロジックの分岐（失敗原因別）
- **概要**: DB保存失敗の原因を判定し、リトライ可能な場合のみリトライ
  - ネットワークタイムアウト → リトライ
  - トランザクションデッドロック → リトライ
  - 制約違反（重複キー等） → リトライなし
- **メリット**:
  - 最も賢い動作
  - 無駄なリトライを避けられる
- **デメリット**:
  - 実装複雑度が非常に高い
  - DBエラーコードの詳細な分析が必要
  - MVP範囲を大きく超える
- **コスト/リスク**: 実装コストが非常に高い、Phase 2以降で検討

## 決定（Decision）

**選択した選択肢**: Option 2（リトライ1回）

**理由**:
1. **MVP範囲に適切**: シンプルで実装しやすく、3ヶ月のMVP期間に適合
2. **一時的障害への対応**: ネットワーク瞬断やDB高負荷への対応が可能
3. **顧客体験の許容範囲**: 2-3秒の追加待ち時間は許容範囲
4. **コスト・ベネフィットのバランス**: リトライなし（Option 1）より大幅に改善、リトライ3回（Option 3）より実装が容易

**トレードオフの判断基準**:
- 注文ロスト率の目標: 1%未満
- 顧客の待ち時間の上限: 5秒（リトライ含む）
- 実装期間: MVP期間（3ヶ月）内で完了可能

**リトライ戦略の詳細**:
- **リトライ間隔**: 1秒（固定）
- **リトライ対象**: すべてのDB保存失敗（エラーコードを問わない）
  - MVP範囲では、失敗原因の分岐（Option 4）は実装しない
- **失敗時の動作**: 2回連続失敗 → ST_Closing（エラー通知）

## 結果（Consequences）

### ポジティブ
- 一時的な障害（ネットワーク瞬断、DB高負荷）で注文ロストを防げる
- 実装がシンプルで、テストが容易
- 顧客の待ち時間が許容範囲（最大2-3秒）
- 注文ロスト率が大幅に改善（推定: リトライなしの50%削減）

### ネガティブ
- 永続的な障害（DB停止）には効果がない
  - 軽減策: インフラ監視で早期検知、自動復旧
- 2回連続で失敗する場合もある
  - 軽減策: 運用ログで失敗率を監視、閾値超過時はアラート

### ニュートラル
- 変更が必要なファイル:
  - ConversationSpec.md §4 saveOrder（リトライロジックを詳細化）
- 影響範囲:
  - saveOrderツールの実装
  - エラーハンドリング（2回失敗時の動作）
  - 運用監視（DB保存失敗率の監視）

## 関連リンク

- **仕様**: ConversationSpec.md §4 saveOrder
- **OpenQuestions**: OQ-006（この決定により解決）
- **関連ADR**:
  - ADR-001（DB保存タイミング）
  - ADR-002（無音閾値、参考）

## 検証方法

### MVP期間中の検証計画

1. **単体テスト**:
   - [ ] DB接続断でリトライが動作するか
   - [ ] 1回目失敗、2回目成功のケース
   - [ ] 2回連続失敗のケース

2. **結合テスト**:
   - [ ] ネットワーク瞬断のシミュレーション
   - [ ] DB高負荷時の動作確認

3. **運用監視**:
   - [ ] DB保存失敗率を測定（目標: 1%未満）
   - [ ] リトライ成功率を測定
   - [ ] 2回連続失敗の頻度を測定

**合格基準**:
- 注文ロスト率: 1%未満
- DB保存失敗率（2回連続失敗）: 0.1%未満
- リトライ成功率: 80%以上（1回目失敗、2回目成功の割合）

**失敗の兆候**:
- 注文ロスト率が1%を超える
- 2回連続失敗の頻度が高い（0.5%以上）
- リトライ成功率が50%未満（リトライの効果が薄い）

その場合は、以下のアクションを取る:
- リトライ回数を3回に増加（ADR-003をSuperseded、新ADR作成）
- リトライロジックの分岐を実装（Option 4への移行）

## 実装への影響

### saveOrderツール契約の更新

**Input（変更なし）**:
```json
{
  "productId": "ABC123",
  "price": 89800,
  "deliveryDate": "2025-01-05",
  "customerPhone": "+81-90-1234-5678",
  "timestamp": "2025-12-31T10:30:00Z"
}
```

**Output（変更なし）**:
```json
{
  "orderId": "ORD-20251231-001",
  "status": "confirmed"
}
```

**エラーハンドリング（更新）**:
- 1回目失敗 → 1秒待機 → 2回目実行
- 2回目失敗 → ST_Closingへ遷移、エラー通知
- エラーログ記録（失敗原因、リトライ回数、タイムスタンプ）

## 次のアクション

- [x] この ADR を作成（完了）
- [ ] ConversationSpec.md §4 saveOrder を更新（リトライロジックを詳細化）
- [ ] OpenQuestions.md OQ-006 を Resolved に変更
- [ ] saveOrderツールの実装仕様書に反映
